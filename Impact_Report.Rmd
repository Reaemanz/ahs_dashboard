---
title: "R Notebook"
output: html_notebook
---

IMPACT REPORT DATA SETUP


```{r Librarries, message=FALSE, warning=FALSE, paged.print=FALSE}
library(readxl)
library(tidyverse)
library(stringr)

```



```{r}

# Load dataset
raw_graduated_RTV <- read_excel(
  "G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/RTV Graduated Clusters.xlsx", 
  sheet = "RTV Graduated Clusters",
  col_names = TRUE
)

# Save and remove the first row (year row)
year_row <- raw_graduated_RTV[1, ]
df_no_year <- raw_graduated_RTV[-1, ]

# Pivot longer to get tidy format (Cohort, Amount)
df_long1 <- df_no_year %>%
  pivot_longer(
    cols = -`Income Streams`,
    names_to = "Cohort",
    values_to = "Amount"
  )

# Pivot wide to make each 'Income Stream' a column, keeping one row per Cohort
df_wide <- df_long1 %>%
  pivot_wider(
    names_from = `Income Streams`,
    values_from = Amount
  )

# Build Year mapping from the first row
year_vals <- as.character(year_row)[-1]  # Exclude 'Income Streams'
cohort_names <- names(year_row)[-1]

year_df <- tibble(
  Cohort = cohort_names,
  Year = year_vals
)

# Join Year info into wide data
df_wide_v1 <- df_wide %>%
  left_join(year_df, by = "Cohort") %>%
  relocate(Year, .after = Cohort)  # Optional: put Year next to Cohort

# Pivot longer to get tidy format (Cohort, Amount)
df_long2 <- df_wide_v1 %>%
  pivot_longer(
    cols = -c("Cohort","Year" ),
    names_to = "Income Streams",
    values_to = "Amount"
  )


# Extract cohort year and clean district names

Graduated_clusters_RTV <- df_long2 %>%
  mutate(
    # First extract District from the original Cohort string
    District = Cohort %>%
      str_remove_all("\\d+") %>%           # Remove digits
      str_remove_all("Cohort") %>%         # Remove 'Cohort'
      str_replace_all("-", "") %>%         # Remove hyphens
      str_remove("RTV") %>%                # Remove 'RTV'
      str_squish(),                        # Clean whitespace

    # Then extract only the year as Cohort
    Cohort = str_extract(Cohort, "\\b20\\d{2}\\b")
  ) %>%
  select(District, `Income Streams`, Cohort, Year, Amount)

# write.csv(Graduated_clusters_RTV, "Graduated_clusters_RTV.csv")

# Clean District
Graduated_clusters_RTV_v1 <- Graduated_clusters_RTV %>%
  mutate(
    Status = "RTV",
    # District = str_remove(District, "^RTV\\s*"),         # Remove 'Control' at the start
    District = str_remove(District, "\\.*$")                 # Remove trailing dots
  )

Graduated_clusters_RTV_final <- Graduated_clusters_RTV_v1 %>%
  mutate(District = recode(District,
                           "Kanu" = "Kanungu",
                           "Ruk" = "Rukungiri",
                           "Mit" = "Mitooma",
                           "Kag" = "Kagadi")) %>% view()

```

CONTROL GRADUATED CLUSTERS

```{r}

# Load the dataset
raw_control <- read_excel("G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/Control Graduated Clusters.xlsx", 
                     sheet = "Control", col_names = TRUE)

# Save and remove the first row (year row)
year_row_ctrl <- raw_control[1, ]
df_no_year_ctrl <- raw_control[-1, ]

# Pivot longer to get tidy format (Cohort, Amount)
df_long1_ctrl <- df_no_year_ctrl %>%
  pivot_longer(
    cols = -`Income Streams`,
    names_to = "Cohort",
    values_to = "Amount"
  )

# Pivot wide to make each 'Income Stream' a column, keeping one row per Cohort
df_wide_ctrl <- df_long1_ctrl %>%
  pivot_wider(
    names_from = `Income Streams`,
    values_from = Amount
  )

# Build Year mapping from the first row
year_vals_ctrl <- as.character(year_row_ctrl)[-1]  # Exclude 'Income Streams'
cohort_names_ctrl <- names(year_row_ctrl)[-1]

year_df_ctrl <- tibble(
  Cohort = cohort_names_ctrl,
  Year = year_vals_ctrl
)

# Join Year info into wide data
df_wide_ctrl_v1 <- df_wide_ctrl %>%
  left_join(year_df_ctrl, by = "Cohort") %>%
  relocate(Year, .after = Cohort)  # Optional: put Year next to Cohort

# Pivot longer to get tidy format (Cohort, Amount)
df_long2_ctrl <- df_wide_ctrl_v1 %>%
  pivot_longer(
    cols = -c("Cohort","Year" ),
    names_to = "Income Streams",
    values_to = "Amount"
  )


# Extract cohort year and clean district names

Graduated_clusters_Control <- df_long2_ctrl %>%
  mutate(
    # First extract District from the original Cohort string
    District = Cohort %>%
      str_remove_all("\\d+") %>%           # Remove digits
      str_remove_all("Cohort") %>%         # Remove 'Cohort'
      str_replace_all("-", "") %>%         # Remove hyphens
      str_remove("RTV") %>%                # Remove 'RTV'
      str_squish(),                        # Clean whitespace

    # Then extract only the year as Cohort
    Cohort = str_extract(Cohort, "\\b20\\d{2}\\b")
  ) %>%
  select(District, `Income Streams`, Cohort, Year, Amount)

# write.csv(Graduated_clusters_Control, "Graduated_clusters_Control.csv")

# Clean District
Graduated_clusters_Control_final <- Graduated_clusters_Control %>%
  mutate(
    Status = "Control",
    District = str_remove(District, "^Control\\s*"),         # Remove 'Control' at the start
    District = str_remove(District, "\\.*$")                 # Remove trailing dots
  ) %>% view()

# Graduated_clusters_RTV_v1 <- Graduated_clusters_Control %>%
#   mutate(District = recode(District,
#                            "Kanu" = "Kanungu",
#                            "Ruk" = "Rukungiri",
#                            "Mit" = "Mitooma",
#                            "Kag" = "Kagadi")) %>% view()
```


COMBINED GRADUATED_CLUSTERS_CONTROL_RTV


```{r Graduated Clusters Control and RTV, message=FALSE, warning=FALSE, paged.print=FALSE}
combined_RTV_Control_Graduated_Clusters <- bind_rows(Graduated_clusters_RTV_final, Graduated_clusters_Control_final)  %>% view()

# Pivot wider
combined_RTV_Control_Graduated_Clusters_pivoted <- combined_RTV_Control_Graduated_Clusters %>%
  mutate(Amount = as.numeric(Amount),
         `Income Streams` = str_squish(`Income Streams`),
         Year = str_squish(Year)) %>%    # Ensure Amount is numeric
  pivot_wider(
    names_from = Status,
    values_from = Amount
  ) %>% 
  mutate(Year = case_when(
    Year == "12 months" ~ "Year 1",
    Year == "24 months" ~ "Year 2",
    Year == "24 months" ~ "Year 2",
    Year == "36 months" ~ "Year 3",
    Year == "48 months" ~ "Year 4",
    Year == "60 months" ~ "Year 5",
    Year == "72 months" ~ "Year 6",
    TRUE ~ Year
  )) %>% view()

  
```


2018 COHORT - CONTROL BASE


```{r}

# Extract the Control values from Kanungu
kanungu_controls_Base <- combined_RTV_Control_Graduated_Clusters_pivoted %>%
  filter(District == "Kanungu", Cohort == 2018, Year == "Base") %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kanungu_2018 = Control) %>% view()

# Update only the NA Control values in Kisoro
Mapping_2018_Controls_to_Kan_Base <- combined_RTV_Control_Graduated_Clusters_pivoted %>%
  left_join(kanungu_controls_Base, by = "Income Streams") %>%
  mutate(Control = ifelse(
    is.na(Control) & District == "Kisoro" & Cohort == 2018 & Year == "Base",
    Control_Kanungu_2018,
    Control
  )) %>%
  select(-Control_Kanungu_2018) %>% view()

```


2019 COHORT - CONTROL BASE


```{r}

kanungu_Controls_2019 <- Mapping_2018_Controls_to_Kan_Base %>%
  filter(District == "Kanungu", Cohort == "2018", Year == "Year 1", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kanungu_2019 = Control) %>% view()

# Fill NAs in Control for Kisoro & Rukunjiri, Cohort 2019, Year "Base"
Mapping_2019_Controls_to_Kan_Yr1 <- Mapping_2018_Controls_to_Kan_Base %>%
  left_join(kanungu_Controls_2019, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2019 &
      Year == "Base" &
      District %in% c("Kisoro", "Rukungiri", "Kanungu"),
      Control_Kanungu_2019,
      Control
    )
  ) %>%
  select(-Control_Kanungu_2019) %>% view()

```


2020 COHORT CONTROL-BASE [KISORO, KANUNGU, RUKUNGIRI]

```{r}


kanungu_Controls_2020 <- Mapping_2019_Controls_to_Kan_Yr1 %>%
  filter(District == "Kanungu", Cohort == "2018", Year == "Year 2", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kanungu_2020 = Control) %>% view()

# Fill NAs in Control for Kisoro & Rukunjiri, Cohort 2019, Year "Base"
Mapping_2020_Controls_to_Kan_Yr2 <- Mapping_2019_Controls_to_Kan_Yr1 %>%
  left_join(kanungu_Controls_2020, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2020 &
      Year == "Base" &
      District %in% c("Kisoro", "Rukungiri", "Kanungu"),
      Control_Kanungu_2020,
      Control
    )
  ) %>%
  select(-Control_Kanungu_2020) %>% view()

```



2020 COHORT CONTROL-BASE
# KAGADI

```{r}
Mitooma_Controls_2020 <- Mapping_2020_Controls_to_Kan_Yr2 %>%
  filter(District == "Mitooma", Cohort == "2020", Year == "Base", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Mitooma_2020 = Control) %>% view()

# Fill NAs in Control for Kisoro & Rukunjiri, Cohort 2019, Year "Base"
Mapping_Mitooma_Base_2020_Controls_to_Mitooma_Yr2 <- Mapping_2020_Controls_to_Kan_Yr2 %>%
  left_join(Mitooma_Controls_2020, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2020 &
      Year == "Base" &
      District %in% c("Kagadi"),
      Control_Mitooma_2020,
      Control
    )
  ) %>%
  select(-Control_Mitooma_2020) %>% view()
```



2021 COHORT CONTROL-BASE [KANUNGU]
# KANUNGU

```{r}

Kanungu_Controls_2021 <- Mapping_Mitooma_Base_2020_Controls_to_Mitooma_Yr2 %>%
  filter(District == "Kanungu", Cohort == "2018", Year == "Year 3", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kanungu_2021 = Control) %>% view()

# Fill NAs in Control for Kisoro & Rukunjiri, Cohort 2019, Year "Base"
Mapping_Kanungu_2021_Base_Controls_to_kanungu_Yr3 <- Mapping_Mitooma_Base_2020_Controls_to_Mitooma_Yr2 %>%
  left_join(Kanungu_Controls_2021, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2021 &
      Year == "Base" &
      District %in% c("Kanungu"),
      Control_Kanungu_2021,
      Control
    )
  ) %>%
  select(-Control_Kanungu_2021) %>% view()

```

2021 COHORT CONTROL-BASE [KANUNGU]
# RUKUNJIRI

```{r}
Kanungu_Controls_2021 <- Mapping_Kanungu_2021_Base_Controls_to_kanungu_Yr3 %>%
  filter(District == "Kanungu", Cohort == "2018", Year == "Year 3", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kanungu_2021 = Control) %>% view()

# Fill NAs in Control for Kisoro & Rukunjiri, Cohort 2019, Year "Base"
Mapping_Rukunjiri_2021_Base_Controls_to_kanungu_Yr3 <- Mapping_Kanungu_2021_Base_Controls_to_kanungu_Yr3 %>%
  left_join(Kanungu_Controls_2021, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2021 &
      Year == "Base" &
      District %in% c("Rukungiri"),
      Control_Kanungu_2021,
      Control
    )
  ) %>%
  select(-Control_Kanungu_2021) %>% view()
```


2021 COHORT CONTROL-BASE [mitooma Yr]
# MITOOMA

```{r}

Mitooma_Controls_2021 <- Mapping_Kanungu_2021_Base_Controls_to_kanungu_Yr3 %>%
  filter(District == "Mitooma", Cohort == "2020", Year == "Year 1", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Mitooma_2021 = Control) %>% view()

# Fill NAs in Control for Mitooma, Cohort 2021, Year "Base"
Mapping_Mitooma_2021_Base_Controls_to_Mitooma_Yr1 <- Mapping_Rukunjiri_2021_Base_Controls_to_kanungu_Yr3 %>%
  left_join(Mitooma_Controls_2021, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2021 &
      Year == "Base" &
      District %in% c("Mitooma"),
      Control_Mitooma_2021,
      Control
    )
  ) %>%
  select(-Control_Mitooma_2021) %>% view()
```


2022 COHORT CONTROL-BASE [Kanungu Yr 4]
# Kanungu

```{r}

Kanungu_Controls_2022 <- Mapping_Mitooma_2021_Base_Controls_to_Mitooma_Yr1 %>%
  filter(District == "Kanungu", Cohort == "2018", Year == "Year 4", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kanungu_2022 = Control) %>% view()

# Fill NAs in Control for Mitooma, Cohort 2021, Year "Base"
Mapping_Kanungu_2022_Base_Control_to_Kanungu_Yr4 <- Mapping_Mitooma_2021_Base_Controls_to_Mitooma_Yr1 %>%
  left_join(Kanungu_Controls_2022, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2022 &
      Year == "Base" &
      District %in% c("Kanungu"),
      Control_Kanungu_2022,
      Control
    )
  ) %>%
  select(-Control_Kanungu_2022) %>% view()

```

2022 COHORT CONTROL-BASE [Kanungu Yr 4]
# Rukungiri

```{r}
Kanungu_Controls_2022 <- Mapping_Kanungu_2022_Base_Control_to_Kanungu_Yr4 %>%
  filter(District == "Kanungu", Cohort == "2018", Year == "Year 4", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kanungu_2022 = Control) %>% view()

# Fill NAs in Control for Mitooma, Cohort 2021, Year "Base"
Mapping_Rukungiri_2022_Base_Control_to_Kanungu_Yr4 <- Mapping_Kanungu_2022_Base_Control_to_Kanungu_Yr4 %>%
  left_join(Kanungu_Controls_2022, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2022 &
      Year == "Base" &
      District %in% c("Rukungiri"),
      Control_Kanungu_2022,
      Control
    )
  ) %>%
  select(-Control_Kanungu_2022) %>% view()

```

2022 COHORT CONTROL-BASE [Mitooma Yr 2]
# Mitooma

```{r}
Mitooma_Controls_2022 <- Mapping_Rukungiri_2022_Base_Control_to_Kanungu_Yr4 %>%
  filter(District == "Mitooma", Cohort == "2020", Year == "Year 2", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Mitooma_2022 = Control) %>% view()

# Fill NAs in Control for Mitooma, Cohort 2021, Year "Base"
Mapping_Mitooma_2022_Base_Control_to_Mitooma_Yr2 <- Mapping_Rukungiri_2022_Base_Control_to_Kanungu_Yr4 %>%
  left_join(Mitooma_Controls_2022, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2022 &
      Year == "Base" &
      District %in% c("Mitooma"),
      Control_Mitooma_2022,
      Control
    )
  ) %>%
  select(-Control_Mitooma_2022) %>% view()
```

2022 COHORT CONTROL-BASE [Rubanda Yr 1]
# Rubanda

```{r}

Rubanda_Controls_2022 <- Mapping_Mitooma_2022_Base_Control_to_Mitooma_Yr2 %>%
  filter(District == "Rubanda", Cohort == "2021", Year == "Year 1", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Rubanda_2022 = Control) %>% view()

# Fill NAs in Control for Mitooma, Cohort 2021, Year "Base"
Mapping_Rubanda_2022_Base_Control_to_Rubanda_Yr1 <- Mapping_Mitooma_2022_Base_Control_to_Mitooma_Yr2 %>%
  left_join(Rubanda_Controls_2022, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2022 &
      Year == "Base" &
      District %in% c("Rubanda"),
      Control_Rubanda_2022,
      Control
    )
  ) %>%
  select(-Control_Rubanda_2022) %>% view()
```


2022 COHORT CONTROL-BASE [Mitooma Yr 2]
# Rubirizi

```{r}

Mitooma_Controls_2022 <- Mapping_Rubanda_2022_Base_Control_to_Rubanda_Yr1 %>%
  filter(District == "Mitooma", Cohort == "2020", Year == "Year 2", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Mitooma_2022 = Control) %>% view()

# Fill NAs in Control for Mitooma, Cohort 2021, Year "Base"
Mapping_Rubirizi_2022_Base_Control_to_Mitooma_Yr2 <- Mapping_Rubanda_2022_Base_Control_to_Rubanda_Yr1 %>%
  left_join(Mitooma_Controls_2022, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2022 &
      Year == "Base" &
      District %in% c("Rubirizi"),
      Control_Mitooma_2022,
      Control
    )
  ) %>%
  select(-Control_Mitooma_2022) %>% view()
```


2022 COHORT CONTROL-BASE [Kibaale Base]
# Kyenjojo


```{r}
Kibaale_Controls_2022 <- Mapping_Rubirizi_2022_Base_Control_to_Mitooma_Yr2 %>%
  filter(District == "Kibaale", Cohort == "2022", Year == "Base", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kibaale_2022 = Control) %>% view()

# Fill NAs in Control for Kyenjojo, Cohort 2022, Year "Base"
Mapping_Kyenjojo_2022_Base_Control_to_Kibaale_Base <- Mapping_Rubirizi_2022_Base_Control_to_Mitooma_Yr2 %>%
  left_join(Kibaale_Controls_2022, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2022 &
      Year == "Base" &
      District %in% c("Kyenjojo"),
      Control_Kibaale_2022,
      Control
    )
  ) %>%
  select(-Control_Kibaale_2022) %>% view()
```


2022 COHORT CONTROL-BASE [Kibaale Base]
# Kagadi Gac

```{r}

Kibaale_Controls_2022 <- Mapping_Kyenjojo_2022_Base_Control_to_Kibaale_Base %>%
  filter(District == "Kibaale", Cohort == "2022", Year == "Base", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kibaale_2022 = Control) %>% view()

# Fill NAs in Control for Kyenjojo, Cohort 2022, Year "Base"
Mapping_Kagadi_Gac_2022_Base_Control_to_Kibaale_Base <- Mapping_Kyenjojo_2022_Base_Control_to_Kibaale_Base %>%
  left_join(Kibaale_Controls_2022, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2022 &
      Year == "Base" &
      District %in% c("Kagadi GAC"),
      Control_Kibaale_2022,
      Control
    )
  ) %>%
  select(-Control_Kibaale_2022) %>% view()
```


2022 COHORT CONTROL-BASE [Kibaale Base]
# Kagadi Non Gac

```{r}

Kibaale_Controls_2022 <- Mapping_Kagadi_Gac_2022_Base_Control_to_Kibaale_Base %>%
  filter(District == "Kibaale", Cohort == "2022", Year == "Base", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kibaale_2022 = Control) %>% view()

# Fill NAs in Control for Kyenjojo, Cohort 2022, Year "Base"
Mapping_Kagadi_NonGac_2022_Base_Control_to_Kibaale_Base <- Mapping_Kagadi_Gac_2022_Base_Control_to_Kibaale_Base %>%
  left_join(Kibaale_Controls_2022, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2022 &
      Year == "Base" &
      District %in% c("Kagadi NonGAC"),
      Control_Kibaale_2022,
      Control
    )
  ) %>%
  select(-Control_Kibaale_2022) %>% view()
```

DROP KISORO

```{r}

Base_all_cohorts <- Mapping_Kagadi_NonGac_2022_Base_Control_to_Kibaale_Base %>%
  filter(District != "Kisoro") %>% view()

```


## YEAR ONE

2018 COHORT - CONTROL YEAR ONE


```{r}

# Extract the Control values from Kanungu
kanungu_controls_Year1 <- Base_all_cohorts %>%
  filter(District == "Kanungu", Cohort == 2018, Year == "Year 1", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kanungu_2018 = Control) %>% view()

# Update only the NA Control values in Kanungu
Mapping_2018_Controls_to_Kan_Year1 <- Base_all_cohorts %>%
  left_join(kanungu_controls_Year1, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
    is.na(Control) & District == "Kanungu" & Cohort == 2018 & Year == "Year 1",
    Control_Kanungu_2018,
    Control
  )) %>%
  select(-Control_Kanungu_2018) %>% view()

```


2019 COHORT - CONTROL Year 1
# Kanungu


```{r}

kanungu_Controls_2019_Year1 <- Mapping_2018_Controls_to_Kan_Year1 %>%
  filter(District == "Kanungu", Cohort == "2018", Year == "Year 2", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kanungu_2019 = Control) %>% view()

# Fill NAs in Control for Kanungu, Cohort 2019, Year "Base"
Mapping_2019_Controls_to_Kan_Yr2 <- Mapping_2018_Controls_to_Kan_Year1 %>%
  left_join(kanungu_Controls_2019_Year1, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2019 &
      Year == "Year 1" &
      District %in% c("Kanungu"),
      Control_Kanungu_2019,
      Control
    )
  ) %>%
  select(-Control_Kanungu_2019) %>% view()

```

2019 COHORT - CONTROL Year  1
# Rukungiri


```{r}

kanungu_Controls_2019_Year1 <- Mapping_2019_Controls_to_Kan_Yr2 %>%
  filter(District == "Kanungu", Cohort == "2018", Year == "Year 2", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kanungu_2019 = Control) %>% view()

# Fill NAs in Control for Kanungu, Cohort 2019, Year "Base"
Mapping_2019_Controls_to_Rukungiri_Yr2 <- Mapping_2019_Controls_to_Kan_Yr2 %>%
  left_join(kanungu_Controls_2019_Year1, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2019 &
      Year == "Year 1" &
      District %in% c("Rukungiri"),
      Control_Kanungu_2019,
      Control
    )
  ) %>%
  select(-Control_Kanungu_2019) %>% view()

```


2020 COHORT CONTROL-BASE [KISORO, KANUNGU, RUKUNGIRI]

```{r}


kanungu_Controls_2020_Year1 <- Mapping_2019_Controls_to_Rukungiri_Yr2 %>%
  filter(District == "Kanungu", Cohort == "2018", Year == "Year 3", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kanungu_2020 = Control) %>% view()

# Fill NAs in Control for Kisoro & Rukunjiri, Cohort 2019, Year "Base"
Mapping_2020_Controls_to_Kan_Yr2 <- Mapping_2019_Controls_to_Rukungiri_Yr2 %>%
  left_join(kanungu_Controls_2020_Year1, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2020 &
      Year == "Year 1" &
      District %in% c("Kisoro", "Rukungiri", "Kanungu"),
      Control_Kanungu_2020,
      Control
    )
  ) %>%
  select(-Control_Kanungu_2020) %>% view()

```


2020 COHORT CONTROL- YEAR ONE
# Mitooma

```{r}
Mitooma_Controls_2020_Year1 <- Mapping_2020_Controls_to_Kan_Yr2 %>%
  filter(District == "Mitooma", Cohort == "2020", Year == "Year 2", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Mitooma_2020 = Control) %>% view()

# Fill NAs in Control for Kisoro & Rukunjiri, Cohort 2019, Year "Base"
Mapping_Mitooma_Year1_2020_Controls_to_Mitooma_Yr1 <- Mapping_2020_Controls_to_Kan_Yr2 %>%
  left_join(Mitooma_Controls_2020_Year1, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2020 &
      Year == "Year 1" &
      District %in% c("Mitooma"),
      Control_Mitooma_2020,
      Control
    )
  ) %>%
  select(-Control_Mitooma_2020) %>% view()
```


2020 COHORT CONTROL- Year 1
# KAGADI

```{r}
Mitooma_Controls_2020_Year1 <- Mapping_Mitooma_Year1_2020_Controls_to_Mitooma_Yr1 %>%
  filter(District == "Mitooma", Cohort == "2020", Year == "Year 2", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Mitooma_2020 = Control) %>% view()

# Fill NAs in Control for Kisoro & Rukunjiri, Cohort 2019, Year "Base"
Mapping_Kagadi_Base_2020_Controls_to_Mitooma_Yr1 <- Mapping_Mitooma_Year1_2020_Controls_to_Mitooma_Yr1 %>%
  left_join(Mitooma_Controls_2020_Year1, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2020 &
      Year == "Year 1" &
      District %in% c("Kagadi"),
      Control_Mitooma_2020,
      Control
    )
  ) %>%
  select(-Control_Mitooma_2020) %>% view()
```


2021 COHORT CONTROL- YEAR ONE [KANUNGU]
# KANUNGU

```{r}


Kanungu_Controls_2021_Year1 <- Mapping_Kagadi_Base_2020_Controls_to_Mitooma_Yr1 %>%
  filter(District == "Kanungu", Cohort == "2018", Year == "Year 4", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kanungu_2021 = Control) %>% view()

# Fill NAs in Control for Kisoro & Rukunjiri, Cohort 2019, Year "Base"
Mapping_Kanungu_2021_Year1_Controls_to_kanungu_Yr4 <- Mapping_Kagadi_Base_2020_Controls_to_Mitooma_Yr1 %>%
  left_join(Kanungu_Controls_2021_Year1, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2021 &
      Year == "Year 1" &
      District %in% c("Kanungu"),
      Control_Kanungu_2021,
      Control
    )
  ) %>%
  select(-Control_Kanungu_2021) %>% view()

```


2021 COHORT CONTROL- YEAR ONE [KANUNGU]
# RUKUNJIRI

```{r}
Kanungu_Controls_2021_Year1 <- Mapping_Kanungu_2021_Year1_Controls_to_kanungu_Yr4 %>%
  filter(District == "Kanungu", Cohort == "2018", Year == "Year 4", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kanungu_2021 = Control) %>% view()

# Fill NAs in Control for Kisoro & Rukunjiri, Cohort 2019, Year "Base"
Mapping_Rukunjiri_2021_Year1_Controls_to_kanungu_Yr3 <- Mapping_Kanungu_2021_Year1_Controls_to_kanungu_Yr4 %>%
  left_join(Kanungu_Controls_2021_Year1, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2021 &
      Year == "Year 1" &
      District %in% c("Rukungiri"),
      Control_Kanungu_2021,
      Control
    )
  ) %>%
  select(-Control_Kanungu_2021) %>% view()
```


2021 COHORT CONTROL- YEAR ONE [mitooma Yr]
# MITOOMA

```{r}

Mitooma_Controls_2021_Year1 <- Mapping_Rukunjiri_2021_Year1_Controls_to_kanungu_Yr3 %>%
  filter(District == "Mitooma", Cohort == "2020", Year == "Year 3", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Mitooma_2021 = Control) %>% view()

# Fill NAs in Control for Mitooma, Cohort 2021, Year "Base"
Mapping_Mitooma_2021_Year1_Controls_to_Mitooma_Yr3 <- Mapping_Rukunjiri_2021_Year1_Controls_to_kanungu_Yr3 %>%
  left_join(Mitooma_Controls_2021_Year1, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2021 &
      Year == "Year 1" &
      District %in% c("Mitooma"),
      Control_Mitooma_2021,
      Control
    )
  ) %>%
  select(-Control_Mitooma_2021) %>% view()
```


2021 COHORT CONTROL- YEAR ONE [Rubanda Yr 1]
# Rubanda

```{r}

Rubanda_Controls_2022_Year1 <- Mapping_Mitooma_2021_Year1_Controls_to_Mitooma_Yr3 %>%
  filter(District == "Rubanda", Cohort == "2021", Year == "Year 2", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Rubanda_2022 = Control) %>% view()

# Fill NAs in Control for Mitooma, Cohort 2021, Year "Base"
Mapping_Rubanda_2022_Year1_Control_to_Rubanda_Yr1 <- Mapping_Mitooma_2021_Year1_Controls_to_Mitooma_Yr3 %>%
  left_join(Rubanda_Controls_2022_Year1, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2021 &
      Year == "Year 1" &
      District %in% c("Rubanda"),
      Control_Rubanda_2022,
      Control
    )
  ) %>%
  select(-Control_Rubanda_2022) %>% view()
```


2022 COHORT CONTROL- YEAR ONE [KANUNGU]
# KANUNGU

```{r}


Kanungu_Controls_2022_Year1 <- Mapping_Rubanda_2022_Year1_Control_to_Rubanda_Yr1 %>%
  filter(District == "Kanungu", Cohort == "2018", Year == "Year 5", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kanungu_2021 = Control) %>% view()

# Fill NAs in Control for Kisoro & Rukunjiri, Cohort 2019, Year "Base"
Mapping_Kanungu_2022_Year1_Controls_to_kanungu_Yr4 <- Mapping_Rubanda_2022_Year1_Control_to_Rubanda_Yr1 %>%
  left_join(Kanungu_Controls_2021_Year1, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2022 &
      Year == "Year 1" &
      District %in% c("Kanungu"),
      Control_Kanungu_2021,
      Control
    )
  ) %>%
  select(-Control_Kanungu_2021) %>% view()

```


2022 COHORT CONTROL- YEAR1 [Kanungu Yr 4]
# Rukungiri

```{r}
Kanungu_Controls_2022_Year1 <- Mapping_Kanungu_2022_Year1_Controls_to_kanungu_Yr4 %>%
  filter(District == "Kanungu", Cohort == "2018", Year == "Year 5", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kanungu_2022 = Control) %>% view()

# Fill NAs in Control for Mitooma, Cohort 2021, Year "Base"
Mapping_Rukungiri_2022_Year1_to_Kanungu_Yr5_Control <- Mapping_Kanungu_2022_Year1_Controls_to_kanungu_Yr4 %>%
  left_join(Kanungu_Controls_2022_Year1, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2022 &
      Year == "Year 1" &
      District %in% c("Rukungiri"),
      Control_Kanungu_2022,
      Control
    )
  ) %>%
  select(-Control_Kanungu_2022) %>% view()

```

2022 COHORT CONTROL-BASE [Mitooma Yr 2]
# Mitooma

```{r}
Mitooma_Controls_2022_Year1 <- Mapping_Rukungiri_2022_Year1_to_Kanungu_Yr5_Control %>%
  filter(District == "Mitooma", Cohort == "2020", Year == "Year 3", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Mitooma_2022 = Control) %>% view()

# Fill NAs in Control for Mitooma, Cohort 2021, Year "Base"
Mapping_Mitooma_2022_Year1_to_Mitooma_Yr3_Control <- Mapping_Rukungiri_2022_Year1_to_Kanungu_Yr5_Control %>%
  left_join(Mitooma_Controls_2022_Year1, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2022 &
      Year == "Year 1" &
      District %in% c("Mitooma"),
      Control_Mitooma_2022,
      Control
    )
  ) %>%
  select(-Control_Mitooma_2022) %>% view()
```

2022 COHORT CONTROL- YEAR1 [Rubanda Yr 2]
# Rubanda

```{r}

Rubanda_Controls_2022_Year1 <- Mapping_Mitooma_2022_Year1_to_Mitooma_Yr3_Control %>%
  filter(District == "Rubanda", Cohort == "2021", Year == "Year 2", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Rubanda_2022 = Control) %>% view()

# Fill NAs in Control for Mitooma, Cohort 2021, Year "Base"
Mapping_Rubanda_2022_Year1_to_Rubanda_Yr2_Control <- Mapping_Mitooma_2022_Year1_to_Mitooma_Yr3_Control %>%
  left_join(Rubanda_Controls_2022_Year1, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2022 &
      Year == "Year 1" &
      District %in% c("Rubanda"),
      Control_Rubanda_2022,
      Control
    )
  ) %>%
  select(-Control_Rubanda_2022) %>% view()

```


2022 COHORT CONTROL- YEAR 1 [Mitooma Yr 2]
# Rubirizi

```{r}

Mitooma_Controls_2022_Year1 <- Mapping_Rubanda_2022_Year1_to_Rubanda_Yr2_Control %>%
  filter(District == "Mitooma", Cohort == "2020", Year == "Year 3", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Mitooma_2022 = Control) %>% view()

# Fill NAs in Control for Mitooma, Cohort 2021, Year "Base"
Mapping_Rubirizi_2022_Year1_to_Mitooma_Yr2_Control <- Mapping_Rubanda_2022_Year1_to_Rubanda_Yr2_Control %>%
  left_join(Mitooma_Controls_2022_Year1, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2022 &
      Year == "Year 1" &
      District %in% c("Rubirizi"),
      Control_Mitooma_2022,
      Control
    )
  ) %>%
  select(-Control_Mitooma_2022) %>% view()
```

2022 COHORT CONTROL- YEAR 1 [Kyenjojo Base]
# Kyenjojo


```{r}
Kibaale_Controls_2022_Year1 <- Mapping_Rubirizi_2022_Year1_to_Mitooma_Yr2_Control %>%
  filter(District == "Kibaale", Cohort == "2022", Year == "Year 1", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kibaale_2022 = Control) %>% view()

# Fill NAs in Control for Kyenjojo, Cohort 2022, Year "Base"
Mapping_Kyenjojo_2022_Year1_to_Kibaale_Year_Control <- Mapping_Rubirizi_2022_Year1_to_Mitooma_Yr2_Control %>%
  left_join(Kibaale_Controls_2022_Year1, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2022 &
      Year == "Year 1" &
      District %in% c("Kyenjojo"),
      Control_Kibaale_2022,
      Control
    )
  ) %>%
  select(-Control_Kibaale_2022) %>% view()
```

2022 COHORT CONTROL-YEAR 1 [Kaliro Base]
# Kaliro


```{r}
Kaliro_Controls_2022_Year1 <- Mapping_Kyenjojo_2022_Year1_to_Kibaale_Year_Control %>%
  filter(District == "Kaliro", Cohort == "2022", Year == "Year 1", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kaliro_2022 = Control) %>% view()

# Fill NAs in Control for Kyenjojo, Cohort 2022, Year "Base"
Mapping_Kaliro_2022_Year1_to_Kaliro_Year1_Control <- Mapping_Kyenjojo_2022_Year1_to_Kibaale_Year_Control %>%
  left_join(Kaliro_Controls_2022_Year1, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2022 &
      Year == "Year 1" &
      District %in% c("Kaliro"),
      Control_Kaliro_2022,
      Control
    )
  ) %>%
  select(-Control_Kaliro_2022) %>% view()

# Filter out Kaliro 2022 Year 1 copy
Kaliro_filtered <- Mapping_Kaliro_2022_Year1_to_Kaliro_Year1_Control %>%
  filter(!(District == "Kaliro" & Cohort == "2022" & Year == "Year 1" & is.na(RTV))) %>% view()

```


2022 COHORT CONTROL- YEAR 1 [Kibaale Year1]
# Kagadi Gac

```{r}

Kibaale_Controls_2022_Year1 <- Kaliro_filtered %>%
  filter(District == "Kibaale", Cohort == "2022", Year == "Year 1", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kibaale_2022 = Control) %>% view()

# Fill NAs in Control for Kyenjojo, Cohort 2022, Year "Base"
Mapping_Kagadi_Gac_2022_Year1_to_Kibaale_Year1_Control <- Kaliro_filtered %>%
  left_join(Kibaale_Controls_2022_Year1, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2022 &
      Year == "Year 1" &
      District %in% c("Kagadi GAC"),
      Control_Kibaale_2022,
      Control
    )
  ) %>%
  select(-Control_Kibaale_2022) %>% view()
```


2022 COHORT CONTROL-BASE [Kibaale Base]
# Kagadi Non Gac

```{r}

Kibaale_Controls_2022_Year1 <- Mapping_Kagadi_Gac_2022_Year1_to_Kibaale_Year1_Control %>%
  filter(District == "Kibaale", Cohort == "2022", Year == "Year 1", !is.na(Control)) %>%
  select(`Income Streams`, Control) %>%
  rename(Control_Kibaale_2022 = Control) %>% view()

# Fill NAs in Control for Kyenjojo, Cohort 2022, Year "Base"
Mapping_Kagadi_NonGac_2022_Year1_to_Kibaale_Control <- Mapping_Kagadi_Gac_2022_Year1_to_Kibaale_Year1_Control %>%
  left_join(Kibaale_Controls_2022_Year1, by = "Income Streams") %>%
  mutate(
    Control = ifelse(
      is.na(Control) &
      Cohort == 2022 &
      Year == "Year 1" &
      District %in% c("Kagadi NonGAC"),
      Control_Kibaale_2022,
      Control
    )
  ) %>%
  select(-Control_Kibaale_2022) %>% view()
```














































RTV OVERALL


```{r RTV Overall, message=FALSE, warning=FALSE, paged.print=FALSE}

# Load the dataset
raw_rtv_overall <- read_excel("G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/RTV Overall.xlsx", 
                     sheet = "overall", col_names = FALSE)

# Set first row as column names
colnames(raw_rtv_overall) <- as.character(raw_rtv_overall[1, ])

# Remove the first row (it’s now column headers)
raw_rtv_overall <- raw_rtv_overall[-1, ]

# Check column names to confirm
# colnames(raw_rtv_overall)

# Remove columns with missing or blank names
raw_rtv_overall_v1 <- raw_rtv_overall[, colnames(raw_rtv_overall) != "" & !is.na(colnames(raw_rtv_overall))]

# Replace #DIV/0! with NA and convert numeric columns
raw_rtv_overall_v2 <- raw_rtv_overall_v1 %>%
  mutate(across(
    .cols = -`Income Streams`,  # exclude the text column
    .fns = ~ na_if(., "#DIV/0!") %>% as.numeric()
  ))


# Convert to long format
raw_rtv_overall_v3 <- raw_rtv_overall_v2 %>%
  pivot_longer(
    cols = -`Income Streams`,     # All columns except "Income Streams"
    names_to = "Period",          # Name for new "period" column
    values_to = "Amount"           # Name for new value column
  )

RTV_Overall <- raw_rtv_overall_v3 %>%
  mutate(Status = "RTV")

view(RTV_Overall)
```


CONTROL OVERALL

```{r Control Overall, message=FALSE, warning=FALSE, paged.print=FALSE}

# Load the dataset
df_raw_Control_overall <- read_excel("G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/Control Overall_Table 15.xlsx", 
                     sheet = "Overall", col_names = FALSE)


# Set first row as column names
colnames(df_raw_Control_overall) <- as.character(df_raw_Control_overall[1, ])

# Remove the first row (it’s now column headers)
df_raw_Control_overall <- df_raw_Control_overall[-1, ]

# Check column names to confirm
# colnames(df_raw_Control_overall)

# Remove columns with missing or blank names
df_raw_Control_overall_v1 <- df_raw_Control_overall[, colnames(df_raw_Control_overall) != "" & !is.na(colnames(df_raw_Control_overall))]

# Replace #DIV/0! with NA and convert numeric columns
df_raw_Control_overall_v2 <- df_raw_Control_overall_v1 %>%
  mutate(across(
    .cols = -`Income Streams`,  # exclude the text column
    .fns = ~ na_if(., "#DIV/0!") %>% as.numeric()
  ))


# Convert to long format
df_raw_Control_overall_v3 <- df_raw_Control_overall_v2 %>%
  pivot_longer(
    cols = -`Income Streams`,     # All columns except "Income Streams"
    names_to = "Period",          # Name for new "period" column
    values_to = "Amount"           # Name for new value column
  )

Control_Overall <- df_raw_Control_overall_v3 %>%
  mutate(Status = "Control")

view(Control_Overall)

```


COMBINED_CONTROL_RTV_OVERALL

```{r}
Overall_RTV_Control_Overall <- bind_rows(RTV_Overall, Control_Overall)  %>% view()

```

DIFF OVERALL

```{r}

diff_values_Overall <- Overall_RTV_Control_Overall %>%
  pivot_wider(names_from = Status, values_from = Amount) %>%
  mutate(Diff = RTV - Control) %>%
  select(`Income Streams`, `Period`, `Diff`)

combined_RTV_Control_Graduated_Overall_Diff <- Overall_RTV_Control_Overall %>%
  left_join(diff_values_Overall, by = c("Income Streams", "Period")) %>% view()

```

GRADUATED COHORTS

RTV GRADUATED COHORTS

```{r RTV Graduated Cohorts, message=FALSE, warning=FALSE, paged.print=FALSE}

# Load the dataset
raw_rtv_graduated_cohorts <- read_excel("G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/Table_16_RTV_Graduated_Cohorts.xlsx", 
                     sheet = "RTV Graduated Cohorts", col_names = FALSE)

# Set first row as column names
colnames(raw_rtv_graduated_cohorts) <- as.character(raw_rtv_graduated_cohorts[1, ])

# Remove the first row (it’s now column headers)
raw_rtv_graduated_cohorts <- raw_rtv_graduated_cohorts[-1, ]

# Check column names to confirm
# colnames(raw_rtv_graduated_cohorts)

# Remove columns with missing or blank names
raw_rtv_graduated_cohorts_v1 <- raw_rtv_graduated_cohorts[, colnames(raw_rtv_graduated_cohorts) != "" & !is.na(colnames(raw_rtv_graduated_cohorts))]

# Replace #DIV/0! with NA and convert numeric columns
raw_rtv_graduated_cohorts_v2 <- raw_rtv_graduated_cohorts_v1 %>%
  mutate(across(
    .cols = -`Income Streams`,  # exclude the text column
    .fns = ~ na_if(., "#DIV/0!") %>% as.numeric()
  ))


# Convert to long format
raw_rtv_graduated_cohorts_v3 <- raw_rtv_graduated_cohorts_v2 %>%
  pivot_longer(
    cols = -`Income Streams`,     # All columns except "Income Streams"
    names_to = "Period",          # Name for new "period" column
    values_to = "Amount"           # Name for new value column
  )

RTV_Graduated_Cohorts <- raw_rtv_graduated_cohorts_v3 %>%
  mutate(Status = "RTV")

view(RTV_Graduated_Cohorts)

```


CONTROL GRADUATED COHORTS

```{r Control Graduated Cohorts, message=FALSE, warning=FALSE, paged.print=FALSE}

# Load the dataset
raw_control_graduated_cohorts <- read_excel("G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/Table_16_Control_Graduated_Cohorts.xlsx", 
                     sheet = "Control Graduated Cohorts", col_names = FALSE)

# Set first row as column names
colnames(raw_control_graduated_cohorts) <- as.character(raw_control_graduated_cohorts[1, ])

# Remove the first row (it’s now column headers)
raw_control_graduated_cohorts <- raw_control_graduated_cohorts[-1, ]

# Check column names to confirm
# colnames(raw_rtv_graduated_cohorts)

# Remove columns with missing or blank names
raw_control_graduated_cohorts_v1 <- raw_control_graduated_cohorts[, colnames(raw_control_graduated_cohorts) != "" & !is.na(colnames(raw_control_graduated_cohorts))]

# Replace #DIV/0! with NA and convert numeric columns
raw_control_graduated_cohorts_v2 <- raw_control_graduated_cohorts_v1 %>%
  mutate(across(
    .cols = -`Income Streams`,  # exclude the text column
    .fns = ~ na_if(., "#DIV/0!") %>% as.numeric()
  ))


# Convert to long format
raw_control_graduated_cohorts_v3 <- raw_control_graduated_cohorts_v2 %>%
  pivot_longer(
    cols = -`Income Streams`,     # All columns except "Income Streams"
    names_to = "Period",          # Name for new "period" column
    values_to = "Amount"           # Name for new value column
  )

Control_Graduated_Cohorts <- raw_control_graduated_cohorts_v3 %>%
  mutate(Status = "Control")

view(Control_Graduated_Cohorts)

```


COMBINED_CONTROL__RTV_GRADUATED_COHORTS

```{r}

combined_RTV_Control_Graduated <- bind_rows(RTV_Graduated_Cohorts, Control_Graduated_Cohorts)  %>% view()

```


DIFF

```{r}
diff_values_Graduated <- combined_RTV_Control_Graduated %>%
  pivot_wider(names_from = Status, values_from = Amount) %>%
  mutate(Diff = RTV - Control) %>%
  select(`Income Streams`, `Period`, `Diff`)

combined_RTV_Control_Graduated_Diff <- combined_RTV_Control_Graduated %>%
  left_join(diff_values_Graduated, by = c("Income Streams", "Period")) %>% view()

```

WEIGHTS

```{r}

# Load the dataset
raw_weights <- read_excel("G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/Weights.xlsx", 
                     sheet = "Weights", col_names = TRUE)

raw_weights_v1 <- raw_weights %>%
  mutate(
    Year = str_extract(Cohort, "\\b\\d{4}\\b"),
    
    District = Cohort %>%
      str_remove_all("(?i)Cohort") %>%
      str_remove_all("(?i)Peer") %>%
      str_remove_all("\\b\\d{4}\\b") %>%
      str_squish(),

    Status = case_when(
      str_detect(Cohort, "(?i)Peer") ~ "Peer",  # if "Peer" is found (case-insensitive)
      TRUE ~ "RTV"                             # otherwise
    )
  )

raw_weights_v2 <- raw_weights_v1 %>%
  select(-Cohort) %>%           # Drop original Cohort column
  rename(Cohort = Year)        # Rename Year to Cohort

# 2nd Pivot

raw_weights_v3 <- raw_weights_v2 %>%
  pivot_longer(
    cols = -c(`Region`, `HHs`, `Cohort`, `District`, `Status`),     # All columns except "Income Streams"
    names_to = "Year",          # Name for new "period" column
    values_to = "Weight"           # Name for new value column
  )

#Remove the word 'Weight-'

raw_weights_v4 <- raw_weights_v3 %>%
  mutate(Year = str_remove(Year, "^Weight-"))

view(raw_weights_v4)

```

TOPLINE ALL COHORTS

RTV

```{r}

# Load the dataset
Topline_All_Cohorts_RTV <- read_excel("G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/Topline_All_Cohorts_RTV.xlsx", 
                     sheet = "Topline", col_names = TRUE)


Topline_All_Cohorts_RTV_v1 <- Topline_All_Cohorts_RTV %>%
  pivot_longer(
    cols = -c(`Topline`),     # All columns except "Income Streams"
    names_to = "Year",          # Name for new "period" column
    values_to = "Amount"           # Name for new value column
  ) %>%
  mutate(Status = "RTV") %>% view()

```

CONTROL

```{r}

# Load the dataset
Topline_All_Cohorts_Control <- read_excel("G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/Topline_All_Cohorts_Control.xlsx", 
                     sheet = "Control", col_names = TRUE)


Topline_All_Cohorts_Control_v1 <- Topline_All_Cohorts_Control %>%
  pivot_longer(
    cols = -c(`Topline`),     # All columns except "Income Streams"
    names_to = "Year",          # Name for new "period" column
    values_to = "Amount"           # Name for new value column
  ) %>% mutate(Status = "Control") %>% view()

```

COMBINED TOPLINES RTV & CONTROL

```{r}

Combined_Toplines_RTV_Control <- bind_rows(Topline_All_Cohorts_RTV_v1, Topline_All_Cohorts_Control_v1) %>% view()
```

COMBINED DIFF

```{r}
diff_values <- Combined_Toplines_RTV_Control %>%
  pivot_wider(names_from = Status, values_from = Amount) %>%
  mutate(Diff = RTV - Control) %>%
  select(Topline, Year, Diff)

Combined_Toplines_RTV_Control_diff <- Combined_Toplines_RTV_Control %>%
  left_join(diff_values, by = c("Topline", "Year")) %>% view()

```

TOPLINES FROM BASE

RTV

```{r RTV Base, message=FALSE, warning=FALSE, paged.print=FALSE}
# Load the dataset
Topline_All_Cohorts_RTV_Base <- read_excel("G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/Toplines_RTV_Base.xlsx", 
                     sheet = "Base", col_names = TRUE)


Topline_All_Cohorts_RTV_Base_v1 <- Topline_All_Cohorts_RTV_Base %>%
  pivot_longer(
    cols = -c(`Topline`),     # All columns except "Income Streams"
    names_to = "Year",          # Name for new "period" column
    values_to = "Amount"           # Name for new value column
  ) %>%   mutate(Status = "RTV") %>% view()

```

CONTROL

```{r}
# Load the dataset
Topline_All_Cohorts_Control_Base <- read_excel("G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/Toplines_Control_Base.xlsx", 
                     sheet = "Base", col_names = TRUE)


Topline_All_Cohorts_Control_Base_v1 <- Topline_All_Cohorts_Control_Base %>%
  pivot_longer(
    cols = -c(`Topline`),     # All columns except "Income Streams"
    names_to = "Year",          # Name for new "period" column
    values_to = "Amount"           # Name for new value column
  ) %>%   mutate(Status = "Control") %>% view()
```


COMBINED 

```{r}

Combined_Toplines_RTV_Control_Base <- bind_rows(Topline_All_Cohorts_RTV_Base_v1, Topline_All_Cohorts_Control_Base_v1) %>% view()

```

COMBINED DIFF

```{r}
Combined_Toplines_RTV_Control_Base_v1 <- Combined_Toplines_RTV_Control_Base %>%
  group_by(Topline, Year) %>%
  mutate(Diff = Amount[Status == "RTV"] - Amount[Status == "Control"]) %>%
  ungroup() %>% view()
```



