---
title: "R Notebook"
output: html_notebook
---

IMPACT REPORT DATA SETUP


```{r Librarries, message=FALSE, warning=FALSE, paged.print=FALSE}
library(readxl)
library(tidyverse)
library(stringr)

```



```{r}


# Step 1: Load dataset
raw_graduated_RTV <- read_excel(
  "G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/RTV Graduated Clusters.xlsx", 
  sheet = "RTV Graduated Clusters",
  col_names = TRUE
)

# Save and remove the first row (year row)
year_row <- raw_graduated_RTV[1, ]
df_no_year <- raw_graduated_RTV[-1, ]

# Pivot longer to get tidy format (Cohort, Amount)
df_long1 <- df_no_year %>%
  pivot_longer(
    cols = -`Income Streams`,
    names_to = "Cohort",
    values_to = "Amount"
  )

# Pivot wide to make each 'Income Stream' a column, keeping one row per Cohort
df_wide <- df_long1 %>%
  pivot_wider(
    names_from = `Income Streams`,
    values_from = Amount
  )

# Build Year mapping from the first row
year_vals <- as.character(year_row)[-1]  # Exclude 'Income Streams'
cohort_names <- names(year_row)[-1]

year_df <- tibble(
  Cohort = cohort_names,
  Year = year_vals
)

# Join Year info into wide data
df_wide_v1 <- df_wide %>%
  left_join(year_df, by = "Cohort") %>%
  relocate(Year, .after = Cohort)  # Optional: put Year next to Cohort

# Pivot longer to get tidy format (Cohort, Amount)
df_long2 <- df_wide_v1 %>%
  pivot_longer(
    cols = -c("Cohort","Year" ),
    names_to = "Income Streams",
    values_to = "Amount"
  )


# Extract cohort year and clean district names

Graduated_clusters_RTV <- df_long2 %>%
  mutate(
    # First extract District from the original Cohort string
    District = Cohort %>%
      str_remove_all("\\d+") %>%           # Remove digits
      str_remove_all("Cohort") %>%         # Remove 'Cohort'
      str_replace_all("-", "") %>%         # Remove hyphens
      str_remove("RTV") %>%                # Remove 'RTV'
      str_squish(),                        # Clean whitespace

    # Then extract only the year as Cohort
    Cohort = str_extract(Cohort, "\\b20\\d{2}\\b")
  ) %>%
  select(District, `Income Streams`, Cohort, Year, Amount)

Graduated_clusters_RTV_v1 <- Graduated_clusters_RTV %>%
  mutate(District = recode(District,
                           "Kanu" = "Kanungu",
                           "Ruk" = "Rukungiri",
                           "Mit" = "Mitooma",
                           "Kag" = "Kagadi")) %>% view()

```



CONTROL DATASET

```{r Control Graduated Clusters, message=FALSE, warning=FALSE, paged.print=FALSE}

# Load the dataset
df_raw_control <- read_excel("G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/Control Graduated Clusters.xlsx", 
                     sheet = "Control", col_names = FALSE)


# Set the first row as column names
colnames(df_raw_control) <- as.character(df_raw_control[1, ])
df_raw_control_v1 <- df_raw_control[-1, ]  # Remove the row that became column names

# Extract the Income Streams row. To be used as the Period column
income_streams <- df_raw_control_v1[1, ]  # 2nd row is Income Streams
df_raw_control_v2 <- df_raw_control_v1[-1, ]        # Remove Income Streams row from data

periods <- unlist(income_streams)[-1]  # exclude the first column

df_raw_control_v3 <- df_raw_control_v2 %>%
  pivot_longer(cols = -1, names_to = "Cohort_District", values_to = "Amount") %>%
  mutate(Year = rep(periods, each = nrow(df_raw_control_v2))) %>%  # 'Year' from income_streams
  rename(`Income Stream` = 1)  # First column is the income stream category

# Extract cohort year and clean district names

Graduated_clusters_control <- df_raw_control_v3 %>%
  mutate(
    Cohort = str_extract(Cohort_District, "\\b20\\d{2}\\b"),
    District = Cohort_District %>%
      str_remove_all("\\d+") %>%           # Remove digits
      str_remove_all("Cohort") %>%         # Remove the word 'Cohort'
      str_remove_all("Control") %>%         # Remove the word 'Control'
      str_replace_all("-", "") %>%         # Remove hyphens
      str_remove("RTV") %>%                # Remove 'RTV' if still present
      str_squish()                         # Trim and clean up whitespace
  ) %>%
  select(District, `Income Stream`, Cohort, Year, Amount)

Graduated_clusters_control_v1 <- Graduated_clusters_control %>%
  mutate(Status = "Control") %>% view()

```

GRADUATED_CLUSTERS_CONTROL_RTV

```{r Graduated Clusters Control and RTV, message=FALSE, warning=FALSE, paged.print=FALSE}
combined_RTV_Control_Graduated_Clusters <- bind_rows(Graduated_clusters_RTV_v2, Graduated_clusters_control_v1)  %>% view()

```

DIFF GRADUATED CLUSTERS

```{r}
combined_RTV_Control_Graduated_Clusters %>% filter(District == "Kagadi", Cohort == "2020") %>% view()
```


```{r}
diff_values_Graduated <- combined_RTV_Control_Graduated_Clusters %>% 
  group_by(District, Cohort, Year, Status) %>% arrange(District) %>% utils::View()
  pivot_wider(names_from = Status, values_from = Amount) %>% view()
  mutate(Amount = as.numeric(Amount)) %>%
  group_by(District, `Income Stream`, Cohort, ) %>%
  summarise(Amount = sum(Amount, na.rm = TRUE), .groups = "drop") %>%
  
  
mutate(Diff = RTV - Control) %>%
  select(District, `Income Stream`, Cohort, Year, Diff) %>% view()

combined_RTV_Control_Graduated_Clusters_Diff <- combined_RTV_Control_Graduated_Clusters %>%
  left_join(diff_values_Graduated, by = c(`District`, "Income Streams", "Cohort", "Year")) %>% view()
```
```{r}

# Assuming your dataframe is called df
df_with_diff <- combined_RTV_Control_Graduated_Clusters %>% mutate(Amount = as.numeric(Amount)) %>%
  pivot_wider(names_from = Status, values_from = Amount) %>%  # Separate RTV and Control
  mutate(Diff = RTV - Control) %>%                             # Compute difference
  pivot_longer(cols = c(RTV, Control), names_to = "Status", values_to = "Amount") %>% view() # Return to long format if needed

```

RTV OVERALL


```{r RTV Overall, message=FALSE, warning=FALSE, paged.print=FALSE}

# Load the dataset
raw_rtv_overall <- read_excel("G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/RTV Overall.xlsx", 
                     sheet = "overall", col_names = FALSE)

# Set first row as column names
colnames(raw_rtv_overall) <- as.character(raw_rtv_overall[1, ])

# Remove the first row (it’s now column headers)
raw_rtv_overall <- raw_rtv_overall[-1, ]

# Check column names to confirm
# colnames(raw_rtv_overall)

# Remove columns with missing or blank names
raw_rtv_overall_v1 <- raw_rtv_overall[, colnames(raw_rtv_overall) != "" & !is.na(colnames(raw_rtv_overall))]

# Replace #DIV/0! with NA and convert numeric columns
raw_rtv_overall_v2 <- raw_rtv_overall_v1 %>%
  mutate(across(
    .cols = -`Income Streams`,  # exclude the text column
    .fns = ~ na_if(., "#DIV/0!") %>% as.numeric()
  ))


# Convert to long format
raw_rtv_overall_v3 <- raw_rtv_overall_v2 %>%
  pivot_longer(
    cols = -`Income Streams`,     # All columns except "Income Streams"
    names_to = "Period",          # Name for new "period" column
    values_to = "Amount"           # Name for new value column
  )

RTV_Overall <- raw_rtv_overall_v3 %>%
  mutate(Status = "RTV")

view(RTV_Overall)
```


CONTROL OVERALL

```{r Control Overall, message=FALSE, warning=FALSE, paged.print=FALSE}

# Load the dataset
df_raw_Control_overall <- read_excel("G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/Control Overall_Table 15.xlsx", 
                     sheet = "Overall", col_names = FALSE)


# Set first row as column names
colnames(df_raw_Control_overall) <- as.character(df_raw_Control_overall[1, ])

# Remove the first row (it’s now column headers)
df_raw_Control_overall <- df_raw_Control_overall[-1, ]

# Check column names to confirm
# colnames(df_raw_Control_overall)

# Remove columns with missing or blank names
df_raw_Control_overall_v1 <- df_raw_Control_overall[, colnames(df_raw_Control_overall) != "" & !is.na(colnames(df_raw_Control_overall))]

# Replace #DIV/0! with NA and convert numeric columns
df_raw_Control_overall_v2 <- df_raw_Control_overall_v1 %>%
  mutate(across(
    .cols = -`Income Streams`,  # exclude the text column
    .fns = ~ na_if(., "#DIV/0!") %>% as.numeric()
  ))


# Convert to long format
df_raw_Control_overall_v3 <- df_raw_Control_overall_v2 %>%
  pivot_longer(
    cols = -`Income Streams`,     # All columns except "Income Streams"
    names_to = "Period",          # Name for new "period" column
    values_to = "Amount"           # Name for new value column
  )

Control_Overall <- df_raw_Control_overall_v3 %>%
  mutate(Status = "Control")

view(Control_Overall)

```


COMBINED_CONTROL_RTV_OVERALL

```{r}
Overall_RTV_Control_Overall <- bind_rows(RTV_Overall, Control_Overall)  %>% view()

```

DIFF OVERALL

```{r}

diff_values_Overall <- Overall_RTV_Control_Overall %>%
  pivot_wider(names_from = Status, values_from = Amount) %>%
  mutate(Diff = RTV - Control) %>%
  select(`Income Streams`, `Period`, `Diff`)

combined_RTV_Control_Graduated_Overall_Diff <- Overall_RTV_Control_Overall %>%
  left_join(diff_values_Overall, by = c("Income Streams", "Period")) %>% view()

```

GRADUATED COHORTS

RTV GRADUATED COHORTS

```{r RTV Graduated Cohorts, message=FALSE, warning=FALSE, paged.print=FALSE}

# Load the dataset
raw_rtv_graduated_cohorts <- read_excel("G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/Table_16_RTV_Graduated_Cohorts.xlsx", 
                     sheet = "RTV Graduated Cohorts", col_names = FALSE)

# Set first row as column names
colnames(raw_rtv_graduated_cohorts) <- as.character(raw_rtv_graduated_cohorts[1, ])

# Remove the first row (it’s now column headers)
raw_rtv_graduated_cohorts <- raw_rtv_graduated_cohorts[-1, ]

# Check column names to confirm
# colnames(raw_rtv_graduated_cohorts)

# Remove columns with missing or blank names
raw_rtv_graduated_cohorts_v1 <- raw_rtv_graduated_cohorts[, colnames(raw_rtv_graduated_cohorts) != "" & !is.na(colnames(raw_rtv_graduated_cohorts))]

# Replace #DIV/0! with NA and convert numeric columns
raw_rtv_graduated_cohorts_v2 <- raw_rtv_graduated_cohorts_v1 %>%
  mutate(across(
    .cols = -`Income Streams`,  # exclude the text column
    .fns = ~ na_if(., "#DIV/0!") %>% as.numeric()
  ))


# Convert to long format
raw_rtv_graduated_cohorts_v3 <- raw_rtv_graduated_cohorts_v2 %>%
  pivot_longer(
    cols = -`Income Streams`,     # All columns except "Income Streams"
    names_to = "Period",          # Name for new "period" column
    values_to = "Amount"           # Name for new value column
  )

RTV_Graduated_Cohorts <- raw_rtv_graduated_cohorts_v3 %>%
  mutate(Status = "RTV")

view(RTV_Graduated_Cohorts)

```


CONTROL GRADUATED COHORTS

```{r Control Graduated Cohorts, message=FALSE, warning=FALSE, paged.print=FALSE}

# Load the dataset
raw_control_graduated_cohorts <- read_excel("G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/Table_16_Control_Graduated_Cohorts.xlsx", 
                     sheet = "Control Graduated Cohorts", col_names = FALSE)

# Set first row as column names
colnames(raw_control_graduated_cohorts) <- as.character(raw_control_graduated_cohorts[1, ])

# Remove the first row (it’s now column headers)
raw_control_graduated_cohorts <- raw_control_graduated_cohorts[-1, ]

# Check column names to confirm
# colnames(raw_rtv_graduated_cohorts)

# Remove columns with missing or blank names
raw_control_graduated_cohorts_v1 <- raw_control_graduated_cohorts[, colnames(raw_control_graduated_cohorts) != "" & !is.na(colnames(raw_control_graduated_cohorts))]

# Replace #DIV/0! with NA and convert numeric columns
raw_control_graduated_cohorts_v2 <- raw_control_graduated_cohorts_v1 %>%
  mutate(across(
    .cols = -`Income Streams`,  # exclude the text column
    .fns = ~ na_if(., "#DIV/0!") %>% as.numeric()
  ))


# Convert to long format
raw_control_graduated_cohorts_v3 <- raw_control_graduated_cohorts_v2 %>%
  pivot_longer(
    cols = -`Income Streams`,     # All columns except "Income Streams"
    names_to = "Period",          # Name for new "period" column
    values_to = "Amount"           # Name for new value column
  )

Control_Graduated_Cohorts <- raw_control_graduated_cohorts_v3 %>%
  mutate(Status = "Control")

view(Control_Graduated_Cohorts)

```


COMBINED_CONTROL__RTV_GRADUATED_COHORTS

```{r}

combined_RTV_Control_Graduated <- bind_rows(RTV_Graduated_Cohorts, Control_Graduated_Cohorts)  %>% view()

```


DIFF

```{r}
diff_values_Graduated <- combined_RTV_Control_Graduated %>%
  pivot_wider(names_from = Status, values_from = Amount) %>%
  mutate(Diff = RTV - Control) %>%
  select(`Income Streams`, `Period`, `Diff`)

combined_RTV_Control_Graduated_Diff <- combined_RTV_Control_Graduated %>%
  left_join(diff_values_Graduated, by = c("Income Streams", "Period")) %>% view()

```

WEIGHTS

```{r}

# Load the dataset
raw_weights <- read_excel("G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/Weights.xlsx", 
                     sheet = "Weights", col_names = TRUE)

raw_weights_v1 <- raw_weights %>%
  mutate(
    Year = str_extract(Cohort, "\\b\\d{4}\\b"),
    
    District = Cohort %>%
      str_remove_all("(?i)Cohort") %>%
      str_remove_all("(?i)Peer") %>%
      str_remove_all("\\b\\d{4}\\b") %>%
      str_squish(),

    Status = case_when(
      str_detect(Cohort, "(?i)Peer") ~ "Peer",  # if "Peer" is found (case-insensitive)
      TRUE ~ "RTV"                             # otherwise
    )
  )

raw_weights_v2 <- raw_weights_v1 %>%
  select(-Cohort) %>%           # Drop original Cohort column
  rename(Cohort = Year)        # Rename Year to Cohort

# 2nd Pivot

raw_weights_v3 <- raw_weights_v2 %>%
  pivot_longer(
    cols = -c(`Region`, `HHs`, `Cohort`, `District`, `Status`),     # All columns except "Income Streams"
    names_to = "Year",          # Name for new "period" column
    values_to = "Weight"           # Name for new value column
  )

#Remove the word 'Weight-'

raw_weights_v4 <- raw_weights_v3 %>%
  mutate(Year = str_remove(Year, "^Weight-"))

view(raw_weights_v4)

```

TOPLINE ALL COHORTS

RTV

```{r}

# Load the dataset
Topline_All_Cohorts_RTV <- read_excel("G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/Topline_All_Cohorts_RTV.xlsx", 
                     sheet = "Topline", col_names = TRUE)


Topline_All_Cohorts_RTV_v1 <- Topline_All_Cohorts_RTV %>%
  pivot_longer(
    cols = -c(`Topline`),     # All columns except "Income Streams"
    names_to = "Year",          # Name for new "period" column
    values_to = "Amount"           # Name for new value column
  ) %>%
  mutate(Status = "RTV") %>% view()

```

CONTROL

```{r}

# Load the dataset
Topline_All_Cohorts_Control <- read_excel("G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/Topline_All_Cohorts_Control.xlsx", 
                     sheet = "Control", col_names = TRUE)


Topline_All_Cohorts_Control_v1 <- Topline_All_Cohorts_Control %>%
  pivot_longer(
    cols = -c(`Topline`),     # All columns except "Income Streams"
    names_to = "Year",          # Name for new "period" column
    values_to = "Amount"           # Name for new value column
  ) %>% mutate(Status = "Control") %>% view()

```

COMBINED TOPLINES RTV & CONTROL

```{r}

Combined_Toplines_RTV_Control <- bind_rows(Topline_All_Cohorts_RTV_v1, Topline_All_Cohorts_Control_v1) %>% view()
```

COMBINED DIFF

```{r}
diff_values <- Combined_Toplines_RTV_Control %>%
  pivot_wider(names_from = Status, values_from = Amount) %>%
  mutate(Diff = RTV - Control) %>%
  select(Topline, Year, Diff)

Combined_Toplines_RTV_Control_diff <- Combined_Toplines_RTV_Control %>%
  left_join(diff_values, by = c("Topline", "Year")) %>% view()

```

TOPLINES FROM BASE

RTV

```{r RTV Base, message=FALSE, warning=FALSE, paged.print=FALSE}
# Load the dataset
Topline_All_Cohorts_RTV_Base <- read_excel("G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/Toplines_RTV_Base.xlsx", 
                     sheet = "Base", col_names = TRUE)


Topline_All_Cohorts_RTV_Base_v1 <- Topline_All_Cohorts_RTV_Base %>%
  pivot_longer(
    cols = -c(`Topline`),     # All columns except "Income Streams"
    names_to = "Year",          # Name for new "period" column
    values_to = "Amount"           # Name for new value column
  ) %>%   mutate(Status = "RTV") %>% view()

```

CONTROL

```{r}
# Load the dataset
Topline_All_Cohorts_Control_Base <- read_excel("G:/Shared drives/PEAL Master/03.PEAL Analytics Unit Folder/Impact Report Dashboard/Toplines_Control_Base.xlsx", 
                     sheet = "Base", col_names = TRUE)


Topline_All_Cohorts_Control_Base_v1 <- Topline_All_Cohorts_Control_Base %>%
  pivot_longer(
    cols = -c(`Topline`),     # All columns except "Income Streams"
    names_to = "Year",          # Name for new "period" column
    values_to = "Amount"           # Name for new value column
  ) %>%   mutate(Status = "Control") %>% view()
```


COMBINED 

```{r}

Combined_Toplines_RTV_Control_Base <- bind_rows(Topline_All_Cohorts_RTV_Base_v1, Topline_All_Cohorts_Control_Base_v1) %>% view()

```

COMBINED DIFF

```{r}
Combined_Toplines_RTV_Control_Base_v1 <- Combined_Toplines_RTV_Control_Base %>%
  group_by(Topline, Year) %>%
  mutate(Diff = Amount[Status == "RTV"] - Amount[Status == "Control"]) %>%
  ungroup() %>% view()
```



